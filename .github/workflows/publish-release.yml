name: Reusable Publish Release Workflow

on:
  workflow_call:
    inputs:
      tag_name:
        description: 'Tag name for the release'
        required: true
        type: string
      repository_name:
        description: 'Repository name'
        required: true
        type: string

# 统一配置权限，调用方无需声明
permissions:
  contents: write
  actions: read
  checks: write
  packages: write

jobs:
  publish-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取所有提交历史，用于生成完整的changelog
          persist-credentials: false # 使用 token 进行操作

      - name: Set up Git user
        run: |
          git config --global user.email "${{ vars.GIT_USER_EMAIL }}"
          git config --global user.name "${{ vars.GIT_USER_NAME }}"

      # 解决 git fetch 报错
      - name: Force fetch tags
        run: git fetch --tags --force

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"

      - name: Install Dependencies
        run: |
          # 备份 package.json
          cp package.json package.json.bak
          # 临时移除 dependencies 以避免 npm 尝试安装不存在的 Unity 依赖
          node -e "let pkg=require('./package.json'); delete pkg.dependencies; require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2))"
          # 安装开发依赖
          npm install
          # 恢复原始 package.json (确保发布时包含 dependencies)
          mv package.json.bak package.json

      # 新增步骤：下载远程配置
      - name: Download shared configuration
        run: |
          curl -L https://raw.githubusercontent.com/GameFrameX/public-github-actions/main/.releaserc -o .releaserc

      # 修复包配置
      - name: fix package
        run: npm pkg fix

      - name: Run semantic-release
        run: npx semantic-release
        env:
          # cnb.cool 发布令牌
          NPM_TOKEN: ${{ secrets.CNB_NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.CNB_NPM_TOKEN }}
          # GitHub令牌（自动生成，用于创建Tag/Release）
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}